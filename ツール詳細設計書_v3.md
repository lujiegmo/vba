# 利息計算書作成ツール 詳細設計書 v3.0

## 1. システム概要

### 1.1 目的
本ツールは、借入金に対する利息計算書を自動作成するExcel VBAマクロシステムです。返済予定情報、入出金情報、利率情報を基に、期間別の詳細な利息計算を行い、Excel形式の計算書を自動出力します。

### 1.2 主要機能
- **データ取得・検証機能**: 各種入力データの取得と妥当性検証
- **期間分割計算機能**: 複数の条件による計算期間の自動分割
- **利息計算機能**: 正常分・延滞分・期失分の利息計算
- **Excel出力機能**: テンプレートベースの計算書ファイル生成
- **エラーハンドリング機能**: 包括的なエラー処理と通知
- **重複データ処理機能**: 入出金情報の重複日付処理
- **分割処理機能**: 遅延損害金利率変更による期間分割

### 1.3 技術仕様
- **開発言語**: VBA (Visual Basic for Applications)
- **対象環境**: Microsoft Excel 2016以降
- **ファイル形式**: .xlsm (マクロ有効ワークブック)
- **出力形式**: .xlsx (Excel ワークブック)
- **総行数**: 1,818行 (Module1.bas)

## 2. アーキテクチャ設計

### 2.1 ファイル構成
```
vba-files/
├── Module/
│   └── Module1.bas           # メイン処理モジュール (1,818行)
├── Class/
│   ├── Sheet1.cls            # シートクラス
│   └── ThisWorkbook.cls      # ワークブッククラス
└── 利息計算書作成マクロ.xlsm    # メインワークブック
```

### 2.2 モジュール構成

#### 2.2.1 定数定義セクション (1-100行)
```vba
' 入出金情報関連定数
Private Const 入出金開始行 As Long = 51
Private Const 入出金日列 As Long = 2
Private Const 摘要列 As Long = 3
Private Const 入出金金額列 As Long = 4
Private Const 残高列 As Long = 5
Private Const 約定返済元金列 As Long = 6

' 期失日関連定数
Private Const 期失日列 As Long = 3
Private Const 期失日行 As Long = 30

' 借入利率関連定数
Private Const 借入利率列 As Long = 2
Private Const 借入利率開始日列 As Long = 3
Private Const 借入利率開始行 As Long = 34

' 遅延損害金利率関連定数
Private Const 遅延損害金利率列 As Long = 2
Private Const 遅延損害金利率開始日列 As Long = 3
Private Const 遅延損害金利率開始行 As Long = 15

' 日付関連定数
Private Const 日付初期値 As Date = #1/1/1900#
```

#### 2.2.2 主要関数一覧

| 関数名 | 機能 | 戻り値型 | 行数範囲 |
|--------|------|----------|----------|
| `計算書作成` | メイン処理実行 | Sub | 101-120 |
| `ファイル出力` | 計算書ファイル出力 | Sub | 121-240 |
| `出力データ作成` | 計算データ作成 | Variant | 241-1200 |
| `返済予定情報取得` | 返済予定データ取得 | Variant | 1201-1280 |
| `入出金情報取得` | 入出金データ取得 | Variant | 1281-1380 |
| `入出金情報全体取得` | 全入出金データ取得 | Variant | 1381-1500 |
| `借入利率取得` | 借入利率データ取得 | Variant | 1501-1560 |
| `遅延損害金利率取得` | 遅延損害金利率データ取得 | Variant | 1561-1620 |
| `返済履歴情報取得` | 返済履歴データ取得 | Variant | 1621-1670 |
| `期失日取得` | 期失日取得 | Date | 1671-1685 |
| `計算書の作成パス取得` | 出力パス取得・検証 | String | 1686-1710 |
| `計算期間最初日取得` | 計算開始日算出 | Date | 1711-1790 |
| `分割日ソート` | 日付配列ソート | Sub | 1791-1818 |

## 3. データ設計

### 3.1 入力データ仕様

#### 3.1.1 返済予定情報 (40行目～)
| 列 | セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|----|------|--------|----------|------|------------|------|
| C | C40～ | 返済予定日 | Date | ○ | IsDate() | 空白で終了判定 |
| D | D40～ | 返済元金 | Double | △ | IsNumeric() | 空白時は0設定 |
| - | - | 返済元金累計 | Double | - | 自動計算 | 累積計算値 |

#### 3.1.2 入出金情報 (51行目～)
| 列 | セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|----|------|--------|----------|------|------------|------|
| B | B51～ | 入出金日 | Date | ○ | IsDate() | 空白で終了判定 |
| C | C51～ | 摘要 | String | ○ | - | 「返済分」で終わる行は除外 |
| D | D51～ | 入出金金額 | Double | ○ | IsNumeric() | - |
| E | E51～ | 残高 | Double | ○ | IsNumeric() | - |
| F | F51～ | 延滞中約定返済元金合計 | Double | △ | IsNumeric() | 空白時は前行値継承 |

**重複日付処理ルール**:
- 同一日付で「返済分」と非「返済分」が存在する場合、「返済分」を削除
- 同一日付で非「返済分」が複数存在する場合、エラーを発生

#### 3.1.3 借入利率情報 (34行目～)
| 列 | セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|----|------|--------|----------|------|------------|------|
| B | B34～ | 借入利率 | Double | ○ | IsNumeric() | 空白で終了判定 |
| C | C34～ | 開始日 | Date | △ | IsDate() | 空白時は日付初期値設定 |

#### 3.1.4 遅延損害金利率情報 (15行目～)
| 列 | セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|----|------|--------|----------|------|------------|------|
| B | B15～ | 遅延損害金利率 | Double | ○ | IsNumeric() | 空白で終了判定 |
| C | C15～ | 開始日 | Date | △ | IsDate() | 空白時は日付初期値設定 |

#### 3.1.5 返済履歴情報 (75行目～)
| 列 | セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|----|------|--------|----------|------|------------|------|
| B | B75～ | 日付 | Date | ○ | IsDate() | 空白で終了判定 |
| C | C75～ | 摘要 | String | ○ | - | 利息・遅延損害金判定用 |
| D | D75～ | 出金金額 | Double | ○ | IsNumeric() | - |

#### 3.1.6 設定値
| セル | 項目名 | データ型 | 必須 | 検証ルール | 備考 |
|------|--------|----------|------|------------|------|
| C6 | 顧客番号 | String | ○ | 非空白 | 出力ファイルに設定 |
| C7 | 計算書作成パス | String | ○ | Dir()でフォルダ存在確認 | 出力先パス |
| C10 | 手続理由 | String | ○ | 非空白 | - |
| C11 | 手続開始日 | Date | ○ | IsDate() | - |
| C27 | ローン口座ステータス | String | ○ | 非空白 | 期失処理に影響 |
| C30 | 期失日 | Date | ○ | IsDate() | 計算期間終了日決定 |
| E30 | 期失理由 | String | ○ | 非空白 | 出力ファイルに設定 |

### 3.2 出力データ仕様

#### 3.2.1 計算書レコード (A9セル～)
| 列 | 項目名 | データ型 | 内容 | 数式例 |
|----|--------|----------|------|--------|
| A | 通番 | Long | 連番 | 1, 2, 3... |
| B | ステータス | String | "正常", "延滞", "期失", "期失（劣後）" | - |
| C | イベント | String | "約定返済", "延滞", "破産", "内入" | - |
| D | 約定返済月 | String | "yyyy/mm", "計算中", "ー" | - |
| E | 対象元金 | Double | 計算対象元金 | - |
| F | 計算期間開始日 | Date | 計算開始日 | - |
| G | 区切り | String | "～" | - |
| H | 計算期間終了日 | Date | 計算終了日 | - |
| I | 計算日数 | Long | 日数計算結果 | =H行-F行+1 |
| J | 利率 | Double | 適用利率 | - |
| K | 積数 | String | Excel数式 | =E行*J行*I行 |
| L | 利息金額 | String | Excel数式 | =ROUNDDOWN(K行/365,0) |
| M | 遅延損害金 | String | Excel数式 | =ROUNDDOWN(K行/365,0) |
| N | 借入日 | Date | 借入日 | - |
| O | 借入額 | Double | 借入額 | - |
| P | 返済日 | Date | 返済日 | - |
| Q | 元金_返済額 | Double | 元金返済額 | - |
| R | 利息_返済額 | Double | 利息返済額 | - |
| S | 遅損金_返済額 | Double | 遅延損害金返済額 | - |

#### 3.2.2 出力ファイル設定
| セル | 項目名 | 設定値 | 取得元 |
|------|--------|--------|--------|
| B4 | 顧客番号 | "顧客番号" + 顧客番号 | C6 |
| J2 | 手続開始日 | 手続開始日 | C11 |
| J3 | 期失日 | 期失日 | C30 |
| K3 | 期失理由 | 期失理由 | E30 |

## 4. 処理設計

### 4.1 メイン処理フロー

```mermaid
flowchart TD
    A[計算書作成] --> B[ツールシート取得]
    B --> C[テンプレートシート取得]
    C --> D[ファイル出力]
    D --> E[計算書作成パス取得]
    E --> F[出力データ作成]
    F --> G[新しいワークブック作成]
    G --> H[テンプレートコピー]
    H --> I[データ貼り付け]
    I --> J[設定値設定]
    J --> K[ファイル保存]
    K --> L[完了通知]
```

### 4.2 出力データ作成処理

#### 4.2.1 処理概要
```mermaid
flowchart TD
    A[出力データ作成開始] --> B[各種データ取得]
    B --> C[返済予定情報ループ]
    C --> D[計算期間設定]
    D --> E[分割日リスト作成]
    E --> F[正常分レコード作成]
    F --> G[延滞分レコード作成]
    G --> H[期失分レコード作成]
    H --> I[計レコード作成]
    I --> J[配列サイズ調整]
    J --> K[結果返却]
```

#### 4.2.2 期間分割処理

**分割条件**:
1. 返済予定前月データの日付
2. 入出金情報の日付
3. 借入利率データの開始日
4. 遅延損害金利率データの開始日（新規追加）

**分割ロジック**:
```vba
' 1. 計算期間設定
期間開始日 = DateSerial(Year(返済予定当月データ(0)), Month(返済予定当月データ(0)), 1)
期間開始日 = DateAdd("m", -1, 期間開始日)
If 期間開始日 < 計算期間最初日 Then
    期間開始日 = 計算期間最初日
End If

期間終了日 = DateSerial(Year(返済予定当月データ(0)), Month(返済予定当月データ(0)), 1)
期間終了日 = DateAdd("d", -1, 期間終了日)

' 2. 期失日チェック
If 期間終了日 >= 期失日 Then
    If ローン口座ステータス = "期限切れ" Then
        期間終了日 = 期失日
    Else
        期間終了日 = DateAdd("d", -1, 期失日)
    End If
End If
```

### 4.3 利率適用ロジック

#### 4.3.1 借入利率取得
```vba
' 1. 同一日付検索
For k = 1 To UBound(借入利率データ, 1)
    If 借入利率データ(k, 2) = 計算期間開始日 Then
        利率 = 借入利率データ(k, 1)
        利率見つかった = True
        Exit For
    End If
Next k

' 2. 最大日付検索（同一日付がない場合）
If Not 利率見つかった Then
    Dim 最大日付 As Date
    最大日付 = 日付初期値
    For k = 1 To UBound(借入利率データ, 1)
        If 借入利率データ(k, 2) < 計算期間開始日 And (借入利率データ(k, 2) > 最大日付 Or 最大日付 = 日付初期値) Then
            最大日付 = 借入利率データ(k, 2)
            利率 = 借入利率データ(k, 1)
        End If
    Next k
End If
```

#### 4.3.2 遅延損害金利率取得
- 借入利率と同様のロジックを適用
- 延滞分・期失分レコードで使用
- 期間分割処理により適切な利率を各セグメントに適用

### 4.4 対象元金計算

#### 4.4.1 基本計算式
```
対象元金 = 残高 - 延滞中約定返済元金合計 - 返済元金累計
```

#### 4.4.2 実装ロジック
```vba
' 1. 入出金データから残高・延滞中約定返済元金取得
残高 = 0
延滞中約定返済元金 = 0
Dim 最大日付_入出金 As Date
最大日付_入出金 = 日付初期値

For k = 1 To UBound(入出金データ, 1)
    If 入出金データ(k, 1) < 計算期間開始日_対象元金 And (入出金データ(k, 1) > 最大日付_入出金 Or 最大日付_入出金 = 日付初期値) Then
        最大日付_入出金 = 入出金データ(k, 1)
        残高 = 入出金データ(k, 4)
        延滞中約定返済元金 = 入出金データ(k, 5)
    End If
Next k

対象元金 = 残高 - 延滞中約定返済元金

' 2. 返済予定データから返済元金累計を減算
Dim 返済元金累計_減算 As Double
返済元金累計_減算 = 0
For k = 1 To UBound(返済予定データ, 1)
    If 返済予定データ(k, 1) <= 計算期間開始日_対象元金 Then
        返済元金累計_減算 = 返済予定データ(k, 3)
    End If
Next k

対象元金 = 対象元金 - 返済元金累計_減算
```

### 4.5 数式設定

#### 4.5.1 積数（K列）
```vba
出力結果(出力行数, 出力_積数列) = "=E" & (出力行数 + 出力開始行オフセット) & "*J" & (出力行数 + 出力開始行オフセット) & "*I" & (出力行数 + 出力開始行オフセット)
```

#### 4.5.2 利息金額（L列）
```vba
' J=1の場合
出力結果(出力行数, 出力_利息金額列) = "=ROUNDDOWN(K" & 現在行番号 & "/365,0)"

' J≠1の場合
出力結果(出力行数, 出力_利息金額列) = "=ROUNDDOWN(SUM(K" & J1開始行番号 & ":K" & 現在行番号 & ")/365,0)-SUM(L" & J1開始行番号 & ":L" & (現在行番号 - 1) & ")"
```

#### 4.5.3 遅延損害金（M列）
```vba
' 基本式
出力結果(出力行数, 出力_遅延損害金列) = "=ROUNDDOWN(K" & (出力行数 + 出力開始行オフセット) & "/365,0)"

' 期失分の累計計算
出力結果(出力行数, 出力_遅延損害金列) = "=ROUNDDOWN(SUM(K" & (J1時の行番号_期失 + 出力開始行オフセット) & ":K" & (出力行数 + 出力開始行オフセット) & ")/365,0)-SUM(M" & (J1時の行番号_期失 + 出力開始行オフセット) & ":M" & (出力行数 + 出力開始行オフセット - 1) & ")"
```

### 4.6 レコード種別処理

#### 4.6.1 正常分レコード
- **作成条件**: 返済予定情報の2レコード目以降
- **ステータス**: "正常"
- **イベント**: "約定返済"
- **計算期間**: 返済予定日の前月1日～前月末日
- **利率**: 借入利率
- **分割処理**: 遅延損害金利率変更日による分割対応

#### 4.6.2 延滞分レコード
- **作成条件**: 返済予定日 < 期失日
- **ステータス**: "延滞"
- **イベント**: "約定返済"
- **計算期間**: 返済予定日～期失日前日
- **対象元金**: 返済元金
- **利率**: 遅延損害金利率
- **分割処理**: 遅延損害金利率変更日による分割対応（新規実装）

#### 4.6.3 期失分レコード
- **作成条件**: 期失日～今日
- **ステータス**: "期失" または "期失（劣後）"
- **イベント**: "延滞", "破産", "内入"
- **計算期間**: 期失日～今日
- **利率**: 遅延損害金利率
- **分割処理**: 遅延損害金利率変更日による分割対応（新規実装）

#### 4.6.4 計レコード
- **約定返済月**: "計"
- **利息金額**: 全レコードの利息金額合計 - 利息返済額合計
- **遅延損害金**: 期失分の遅延損害金合計 - 遅損金返済額合計

### 4.7 借入・返済情報設定

#### 4.7.1 借入情報判定
```vba
' 借入または借換の判定
If ((Len(摘要) >= Len(借入摘要借入文字列) And Right(摘要, Len(借入摘要借入文字列)) = 借入摘要借入文字列) Or 
    (Len(摘要) >= Len(借入摘要借換文字列) And Right(摘要, Len(借入摘要借換文字列)) = 借入摘要借換文字列)) Then
    ' 借入情報設定
End If
```

#### 4.7.2 返済情報判定
```vba
' 返済分の判定
If Len(摘要) >= Len(返済摘要返済分文字列) And Right(摘要, Len(返済摘要返済分文字列)) = 返済摘要返済分文字列 Then
    ' 返済情報設定
End If
```

## 5. 重複データ処理設計

### 5.1 入出金情報重複処理

#### 5.1.1 重複検出ロジック
```vba
' 同一日付の重複チェック
For k = 1 To currentRow - 1
    If dataArray(k, 1) = 入出金日 Then
        ' 重複発見時の処理
    End If
Next k
```

#### 5.1.2 重複解決ルール
1. **返済分優先削除**: 同一日付で「返済分」と非「返済分」が存在する場合、「返済分」を削除
2. **非返済分重複エラー**: 同一日付で非「返済分」が複数存在する場合、エラーを発生
3. **無効レコード除外**: 処理完了後、日付が日付初期値のレコードを除外

#### 5.1.3 実装詳細
```vba
' 現在のレコードが「返済分」で、同一日付の非「返済分」が存在する場合
If 現在が返済分 And 既存が非返済分 Then
    GoTo NextRecord  ' 現在のレコードをスキップ
End If

' 現在のレコードが非「返済分」で、同一日付の「返済分」が存在する場合
If 現在が非返済分 And 既存が返済分 Then
    dataArray(k, 1) = 日付初期値  ' 既存のレコードを無効化
End If

' 現在のレコードが非「返済分」で、同一日付の非「返済分」が存在する場合
If 現在が非返済分 And 既存が非返済分 Then
    Err.Raise 13, "入出金情報全体取得", "同一日付に複数の非返済分エントリが存在します。"
End If
```

## 6. エラーハンドリング設計

### 6.1 データ検証

#### 6.1.1 型チェック
```vba
' 日付型チェック
If Not IsDate(cellValue) Then
    Err.Raise 13, "関数名", "セル値が日付型ではありません。"
End If

' 数値型チェック
If Not IsNumeric(cellValue) Then
    Err.Raise 13, "関数名", "セル値が数値型ではありません。"
End If
```

#### 6.1.2 必須項目チェック
```vba
' 空白チェック
If cellValue = "" Or IsEmpty(cellValue) Then
    Err.Raise 13, "関数名", "必須項目が空白です。"
End If
```

#### 6.1.3 パス存在チェック
```vba
' フォルダ存在チェック
If Dir(pathString, vbDirectory) = "" Then
    Err.Raise 76, "計算書の作成パス取得", "指定されたパス '" & pathString & "' はフォルダではありません。"
End If
```

### 6.2 エラーメッセージ設計

#### 6.2.1 メッセージ形式
- **基本形式**: "[関数名]でエラーが発生しました: [詳細メッセージ]"
- **位置情報**: 行番号・列番号を含む
- **対処方法**: 具体的な修正方法を提示

#### 6.2.2 エラーコード体系
| エラーコード | 内容 | 対処方法 |
|-------------|------|----------|
| 13 | 型不一致 | データ型を確認して修正 |
| 76 | パスが見つからない | フォルダパスを確認 |
| 9 | 配列の添字が有効範囲にない | データ範囲を確認 |

### 6.3 リソース管理

#### 6.3.1 メモリ管理
```vba
' 画面更新制御
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

' 処理完了後の復元
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
```

#### 6.3.2 オブジェクト解放
```vba
' エラー発生時のワークブック解放
If Not 新しいワークブック Is Nothing Then
    新しいワークブック.Close SaveChanges:=False
End If
```

## 7. パフォーマンス最適化

### 7.1 メモリ効率化

#### 7.1.1 配列サイズ最適化
```vba
' 動的配列サイズ調整
ReDim 出力結果(1 To 1000, 1 To 19)  ' 初期サイズ
' 処理完了後にサイズ調整
ReDim 最終結果(1 To 出力行数, 1 To 19)
```

#### 7.1.2 一括処理
```vba
' セル範囲一括設定
Dim 貼り付け範囲 As Range
Set 貼り付け範囲 = 新しいワークシート.Range("A" & データ貼り付け開始行).Resize(行数, 列数)
貼り付け範囲.Value = 出力データ
```

### 7.2 処理効率化

#### 7.2.1 重複処理排除
```vba
' 分割日重複チェック
Dim 重複フラグ As Boolean
重複フラグ = False
For k = 1 To 分割日数
    If 分割日リスト(k) = 入出金日 Then
        重複フラグ = True
        Exit For
    End If
Next k
```

#### 7.2.2 ソートアルゴリズム
```vba
' バブルソート実装
Private Sub 分割日ソート(分割日リスト() As Date, 分割日数 As Long)
    Dim i As Long, j As Long
    Dim temp As Date
    
    For i = 1 To 分割日数 - 1
        For j = i + 1 To 分割日数
            If 分割日リスト(i) > 分割日リスト(j) Then
                temp = 分割日リスト(i)
                分割日リスト(i) = 分割日リスト(j)
                分割日リスト(j) = temp
            End If
        Next j
    Next i
End Sub
```

## 8. テスト設計

### 8.1 単体テスト

#### 8.1.1 データ取得関数テスト
| テストケース | 入力条件 | 期待結果 | 確認項目 |
|-------------|----------|----------|----------|
| 正常系_返済予定情報 | 正しいデータ形式 | 配列返却 | データ型・値 |
| 異常系_返済予定情報 | 日付不正 | エラー発生 | エラーメッセージ |
| 境界値_返済予定情報 | 空白データ | 適切な初期値 | デフォルト値設定 |
| 正常系_重複処理 | 同一日付「返済分」「非返済分」 | 「返済分」削除 | 重複解決 |
| 異常系_重複処理 | 同一日付「非返済分」複数 | エラー発生 | エラーメッセージ |

#### 8.1.2 計算ロジックテスト
| テストケース | 入力条件 | 期待結果 | 確認項目 |
|-------------|----------|----------|----------|
| 期間分割_正常 | 複数分割日 | 正しい分割 | 分割数・期間 |
| 期間分割_遅延損害金利率 | 遅延損害金利率変更日 | 正しい分割 | 延滞分・期失分分割 |
| 利率適用_正常 | 利率データ存在 | 正しい利率 | 利率値 |
| 対象元金_正常 | 入出金データ存在 | 正しい元金 | 計算結果 |

### 8.2 結合テスト

#### 8.2.1 データフロー確認
- 各関数間のデータ受け渡し
- 配列サイズの整合性
- エラー伝播の確認
- 重複データ処理の連携

#### 8.2.2 ファイル出力確認
- テンプレートコピー
- データ貼り付け位置
- 数式設定の正確性
- 分割レコードの正確性

### 8.3 システムテスト

#### 8.3.1 シナリオテスト
1. **基本シナリオ**: 標準的なデータでの完全実行
2. **複雑シナリオ**: 多数の分割日を含むデータ
3. **重複データシナリオ**: 重複日付を含むデータ
4. **エラーシナリオ**: 不正データでのエラーハンドリング

#### 8.3.2 パフォーマンステスト
- 大量データでの処理時間測定
- メモリ使用量の監視
- ファイルサイズの確認

## 9. 運用設計

### 9.1 動作環境

#### 9.1.1 システム要件
- **OS**: Windows 10/11
- **Office**: Microsoft Excel 2016以降
- **メモリ**: 4GB以上推奨
- **ディスク**: 100MB以上の空き容量

#### 9.1.2 権限要件
- マクロ実行権限
- 出力先フォルダの書き込み権限
- 一時ファイル作成権限

### 9.2 入力データ要件

#### 9.2.1 データ品質
- 必須項目の完全入力
- 正しいデータ型での入力
- 論理的整合性の確保
- 重複データの適切な処理

#### 9.2.2 データ量制限
- 返済予定情報: 最大100件
- 入出金情報: 最大1000件
- 利率情報: 最大50件

### 9.3 出力ファイル仕様

#### 9.3.1 ファイル命名規則
```
利息計算書_yyyymmdd_hhmmss.xlsx
例: 利息計算書_20241201_143022.xlsx
```

#### 9.3.2 ファイル構成
- **シート名**: "利息計算書"
- **データ開始位置**: A9セル
- **書式**: テンプレートシート準拠

## 10. 保守・拡張設計

### 10.1 定数管理

#### 10.1.1 設定値の一元化
```vba
' 行・列番号の定数化により変更容易性を確保
Private Const 入出金開始行 As Long = 51
Private Const 入出金日列 As Long = 2
Private Const 日付初期値 As Date = #1/1/1900#
```

#### 10.1.2 設定ファイル化の検討
- 将来的な外部設定ファイル対応
- 環境別設定の分離

### 10.2 関数分割設計

#### 10.2.1 単一責任原則
- 各関数は単一の責任を持つ
- 再利用可能な設計
- テスト容易性の確保

#### 10.2.2 依存関係の最小化
- 関数間の結合度を低く保つ
- インターフェースの明確化

### 10.3 拡張ポイント

#### 10.3.1 新しい計算ロジック追加
- 計算式の変更対応
- 新しいレコード種別の追加
- 利率適用ルールの変更
- 分割処理ルールの拡張

#### 10.3.2 出力形式の拡張
- PDF出力対応
- CSV出力対応
- 複数シート出力対応

## 11. セキュリティ設計

### 11.1 データ保護

#### 11.1.1 機密情報の取り扱い
- 顧客情報の適切な処理
- 一時ファイルの安全な削除
- メモリ上のデータクリア

#### 11.1.2 アクセス制御
- マクロ実行権限の制限
- ファイルアクセス権限の確認

### 11.2 監査ログ

#### 11.2.1 処理ログの記録
- 実行日時の記録
- 処理対象データの記録
- エラー発生時の詳細ログ

#### 11.2.2 ログ管理
- ログファイルのローテーション
- 保存期間の設定
- ログレベルの制御

## 12. 新機能・改善点

### 12.1 v3.0での主要改善点

#### 12.1.1 重複データ処理機能
- 入出金情報の同一日付重複処理
- 「返済分」優先削除ロジック
- 非「返済分」重複時のエラー処理

#### 12.1.2 遅延損害金利率分割処理
- 延滞分レコードの遅延損害金利率変更日分割
- 期失分レコードの遅延損害金利率変更日分割
- セグメント別利率適用

#### 12.1.3 借換処理対応
- 借入判定条件に「借換」を追加
- 正常分・延滞分レコードでの借換情報設定

#### 12.1.4 日付初期値定数化
- DateSerial(1900, 1, 1)の定数化
- 保守性・可読性の向上

#### 12.1.5 計算期間最初日取得ロジック改善
- 未返済前月が日付初期値の場合の特別処理
- 入出金最小日付の適用

### 12.2 コード品質向上

#### 12.2.1 コメントの日本語化
- 中国語コメントの日本語変換
- 文字化けコメントの修正
- 統一された日本語コメント標準

#### 12.2.2 エラーハンドリング強化
- より詳細なエラーメッセージ
- 重複データ処理時のエラー対応
- 適切なリソース管理

---

**文書情報**
- **作成日**: 2024年12月
- **バージョン**: 3.0
- **作成者**: システム開発チーム
- **更新履歴**: 
  - v1.0: 初版作成
  - v2.0: 詳細設計追加、期失分処理追加、テスト設計追加
  - v3.0: 重複データ処理、遅延損害金利率分割処理、借換対応、日本語化対応

**関連文書**
- 利息計算書作成マクロ.xlsm
- Module1.bas (1,818行)
- 仕様.txt
- ツール詳細仕様書.md (v2.0)