# 利息計算書作成ツール 詳細仕様書

## 1. 概要

### 1.1 目的
本ツールは、借入金に対する利息計算書を自動作成するExcel VBAマクロです。返済予定情報、入出金情報、利率情報を基に、期間別の利息計算を行い、Excel形式の計算書を出力します。

### 1.2 主要機能
- 返済予定情報の取得と処理
- 入出金情報の取得と処理
- 借入利率・遅延損害金利率の取得と適用
- 期間分割による詳細な利息計算
- Excel形式での計算書出力
- 延滞分レコードの自動生成

## 2. システム構成

### 2.1 ファイル構成
```
vba-files/
├── Module/
│   └── Module1.bas    # メイン処理モジュール
├── Class/
│   ├── Sheet1.cls     # シートクラス
│   └── ThisWorkbook.cls # ワークブッククラス
```

### 2.2 主要関数一覧

| 関数名 | 機能 | 戻り値 |
|--------|------|--------|
| `計算書作成` | メイン処理実行 | なし |
| `ファイル出力` | 計算書ファイル出力 | なし |
| `出力データ作成` | 計算データ作成 | Variant配列 |
| `返済予定情報取得` | 返済予定データ取得 | Variant配列 |
| `入出金情報取得` | 入出金データ取得 | Variant配列 |
| `借入利率取得` | 借入利率データ取得 | Variant配列 |
| `遅延損害金利率取得` | 遅延損害金利率データ取得 | Variant配列 |
| `期失日取得` | 期失日取得 | Date |
| `計算書の作成パス取得` | 出力パス取得 | String |
| `計算期間の最初日` | 計算開始日算出 | Date |

## 3. データ仕様

### 3.1 入力データ

#### 3.1.1 返済予定情報（35行目～）
| 列 | 項目名 | データ型 | 必須 | 備考 |
|----|--------|----------|------|------|
| C | 返済予定日 | Date | ○ | 空白で終了 |
| D | 返済元金 | Double | △ | 空白時は0 |

#### 3.1.2 入出金情報（46行目～）
| 列 | 項目名 | データ型 | 必須 | 備考 |
|----|--------|----------|------|------|
| B | 入出金日 | Date | ○ | 空白で終了 |
| C | 摘要 | String | ○ | 「返済分」で終わる行は除外 |
| D | 入出金金額 | Double | ○ | |
| E | 残高 | Double | ○ | |
| F | 延滞中約定返済元金合計 | Double | △ | 空白時は前行値継承 |

#### 3.1.3 借入利率情報（29行目～）
| 列 | 項目名 | データ型 | 必須 | 備考 |
|----|--------|----------|------|------|
| B | 借入利率 | Double | ○ | 空白で終了 |
| C | 開始日 | Date | △ | 空白時は最小日付 |

#### 3.1.4 遅延損害金利率情報（15行目～）
| 列 | 項目名 | データ型 | 必須 | 備考 |
|----|--------|----------|------|------|
| B | 遅延損害金利率 | Double | ○ | 空白で終了 |
| C | 開始日 | Date | △ | 空白時は最小日付 |

#### 3.1.5 その他設定値
| セル | 項目名 | データ型 | 必須 | 備考 |
|------|--------|----------|------|------|
| C7 | 計算書作成パス | String | ○ | 出力先フォルダパス |
| C25 | 期失日 | Date | ○ | デフォルト日 |

### 3.2 出力データ

#### 3.2.1 計算書レコード（A9セル～）
| 列 | 項目名 | データ型 | 内容 |
|----|--------|----------|------|
| A | 通番 | Long | 連番 |
| B | ステータス | String | "正常" または "延滞" |
| C | イベント | String | "約定返済" |
| D | 約定返済月 | String | "yyyy/mm" 形式 |
| E | 対象元金 | Double | 計算対象元金 |
| F | 計算期間開始日 | Date | 計算開始日 |
| G | 区切り | String | "～" |
| H | 計算期間終了日 | Date | 計算終了日 |
| I | 計算日数 | Long | 日数計算結果 |
| J | 利率 | Double | 適用利率 |
| K | 積数 | String | Excel数式 |
| L | 利息金額 | String | Excel数式 |
| M | 遅延損害金 | String | Excel数式 |

## 4. 処理仕様

### 4.1 メイン処理フロー

```
1. 計算書作成()
   ├── ツールシート取得
   ├── テンプレートシート取得
   └── ファイル出力()
       ├── 計算書作成パス取得
       ├── 出力データ作成()
       │   ├── 返済予定情報取得
       │   ├── 入出金情報取得
       │   ├── 借入利率取得
       │   ├── 遅延損害金利率取得
       │   ├── 期間分割処理
       │   ├── 正常分レコード作成
       │   └── 延滞分レコード作成
       ├── ファイル作成・保存
       └── 完了通知
```

### 4.2 期間分割処理

#### 4.2.1 分割条件
- 返済予定前月データの日付
- 入出金情報の日付
- 借入利率データの開始日
- 遅延損害金利率データの開始日

#### 4.2.2 分割ロジック
1. 計算期間（返済予定日の前月1日～前月末日）を設定
2. 期失日チェック（期失日以降は期失日前日まで）
3. 各データソースから期間内の日付を抽出
4. 重複除去・ソート処理
5. 分割された期間ごとにレコード作成

### 4.3 利率適用ロジック

#### 4.3.1 借入利率
1. 計算期間開始日と同一日付のデータを検索
2. 見つからない場合、計算期間開始日より小さい最大日付を検索
3. 初回検索時（最大日付が1900/1/1）は任意の日付を受け入れ

#### 4.3.2 遅延損害金利率
- 借入利率と同様のロジックを適用

### 4.4 対象元金計算

#### 4.4.1 基本計算式
```
対象元金 = 残高 - 延滞中約定返済元金合計 - 返済元金累計
```

#### 4.4.2 データ取得ロジック
1. 入出金データから計算期間開始日より小さい最大日付のデータを取得
2. 該当データがない場合は最初のデータを使用
3. 返済予定データから計算期間開始日以下の最大日付の返済元金累計を減算

### 4.5 数式設定

#### 4.5.1 積数（K列）
```
=E行番号*J行番号*I行番号
```

#### 4.5.2 利息金額（L列）
- J=1の場合：`=ROUNDDOWN(K行番号/365,0)`
- J≠1の場合：`=ROUNDDOWN(SUM(K(J=1時の行番号):K現在の行番号)/365,0)-SUM(L(J=1時の行番号):L現在の行番号)`

#### 4.5.3 遅延損害金（M列）
```
=ROUNDDOWN(K行番号/365,0)
```

### 4.6 延滞分レコード処理

#### 4.6.1 作成条件
- 返済予定日 < 期失日

#### 4.6.2 設定値
- ステータス："延滞"
- 計算期間開始日：返済予定日
- 計算期間終了日：期失日の前日
- 対象元金：返済元金
- 利率：遅延損害金利率

## 5. エラー処理

### 5.1 データ検証
- 日付型チェック
- 数値型チェック
- 必須項目チェック
- パス存在チェック

### 5.2 エラーメッセージ
- 具体的な行・列情報を含むエラーメッセージ
- エラー発生時のリソース解放

## 6. パフォーマンス最適化

### 6.1 メモリ効率化
- 画面更新停止（Application.ScreenUpdating = False）
- 自動計算停止（Application.Calculation = xlCalculationManual）
- 配列サイズ最適化

### 6.2 処理効率化
- 一括データ取得
- 重複処理の排除
- 適切な配列サイズ設定

## 7. 運用要件

### 7.1 動作環境
- Microsoft Excel 2016以降
- VBAマクロ実行可能環境
- 十分なメモリ容量

### 7.2 入力データ要件
- 正しい形式でのデータ入力
- 必須項目の入力完了
- 出力先フォルダの書き込み権限

### 7.3 出力ファイル
- ファイル名：利息計算書_yyyymmdd_hhmmss.xlsx
- 出力先：指定されたフォルダパス
- テンプレートシートベースの書式

## 8. 保守・拡張性

### 8.1 定数管理
- 行・列番号の定数化
- 設定値の一元管理
- 変更容易性の確保

### 8.2 関数分割
- 機能別関数分割
- 再利用可能な設計
- テスト容易性の確保

### 8.3 コメント・ドキュメント
- 詳細なコメント記述
- 処理ロジックの説明
- 変更履歴の管理

---

**作成日**: 2024年12月
**バージョン**: 1.0
**作成者**: システム開発チーム